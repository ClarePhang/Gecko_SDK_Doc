<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Silicon Labs EFM32 emlib Peripheral Library: release/EM_CMSIS_P1_4.0.0/emlib/src/em_adc.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_99634199317e4752b1934502e0d836c4.html">release</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_ef8fe3615cb8c81ea34985a2c039aa1a.html">EM_CMSIS_P1_4.0.0</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_e920a447b543d2a9629bb351881860c5.html">emlib</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_787edd173f767fae4d0b9f311e27bdfa.html">src</a>
  </div>
</div>
<div class="contents">
<h1>em_adc.c</h1><a href="em__adc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************/</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="em__adc_8h.html" title="Analog to Digital Converter (ADC) peripheral API.">em_adc.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#if defined(ADC_COUNT) &amp;&amp; (ADC_COUNT &gt; 0)</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="em__cmu_8h.html" title="Clock management unit (CMU) API.">em_cmu.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="em__assert_8h.html" title="EFM32 peripheral API &amp;quot;assert&amp;quot; implementation.">em_assert.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">/***************************************************************************/</span>
<a name="l00045"></a>00045 <span class="comment">/***************************************************************************/</span>
<a name="l00051"></a>00051 <span class="comment">/*******************************************************************************</span>
<a name="l00052"></a>00052 <span class="comment"> *******************************   DEFINES   ***********************************</span>
<a name="l00053"></a>00053 <span class="comment"> ******************************************************************************/</span>
<a name="l00054"></a>00054 
<a name="l00058"></a>00058 <span class="preprocessor">#define ADC_REF_VALID(ref)    ((ref) == ADC0)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <span class="preprocessor">#define ADC_MAX_CLOCK    13000000</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="preprocessor">#define ADC_MIN_CLOCK    32000</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00069"></a>00069 <span class="comment">/*******************************************************************************</span>
<a name="l00070"></a>00070 <span class="comment"> ***************************   LOCAL FUNCTIONS   *******************************</span>
<a name="l00071"></a>00071 <span class="comment"> ******************************************************************************/</span>
<a name="l00072"></a>00072 
<a name="l00075"></a>00075 <span class="comment">/***************************************************************************/</span>
<a name="l00093"></a>00093 <span class="keyword">static</span> <span class="keywordtype">void</span> ADC_CalibrateLoadScan(ADC_TypeDef *adc, <a class="code" href="group__ADC.html#ga90e3c5bfd7ebdd7686cf65bb896e4eac">ADC_Ref_TypeDef</a> ref)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095   uint32_t cal;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="comment">/* Load proper calibration data depending on selected reference */</span>
<a name="l00098"></a>00098   <span class="comment">/* NOTE: We use ...SCAN... defines below, they are the same as */</span>
<a name="l00099"></a>00099   <span class="comment">/* similar ...SINGLE... defines. */</span>
<a name="l00100"></a>00100   <span class="keywordflow">switch</span> (ref)
<a name="l00101"></a>00101   {
<a name="l00102"></a>00102   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca97f40de792c64102ddbf60b0faa82c32">adcRef1V25</a>:
<a name="l00103"></a>00103     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SCANOFFSET_MASK | _ADC_CAL_SCANGAIN_MASK);
<a name="l00104"></a>00104     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_1V25_GAIN_MASK) &gt;&gt;
<a name="l00105"></a>00105             _DEVINFO_ADC0CAL0_1V25_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SCANGAIN_SHIFT;
<a name="l00106"></a>00106     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_1V25_OFFSET_MASK) &gt;&gt;
<a name="l00107"></a>00107             _DEVINFO_ADC0CAL0_1V25_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SCANOFFSET_SHIFT;
<a name="l00108"></a>00108     adc-&gt;CAL = cal;
<a name="l00109"></a>00109     <span class="keywordflow">break</span>;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca611947cfb4d734ac07e6d44967ca28ce">adcRef2V5</a>:
<a name="l00112"></a>00112     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SCANOFFSET_MASK | _ADC_CAL_SCANGAIN_MASK);
<a name="l00113"></a>00113     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_2V5_GAIN_MASK) &gt;&gt;
<a name="l00114"></a>00114             _DEVINFO_ADC0CAL0_2V5_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SCANGAIN_SHIFT;
<a name="l00115"></a>00115     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_2V5_OFFSET_MASK) &gt;&gt;
<a name="l00116"></a>00116             _DEVINFO_ADC0CAL0_2V5_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SCANOFFSET_SHIFT;
<a name="l00117"></a>00117     adc-&gt;CAL = cal;
<a name="l00118"></a>00118     <span class="keywordflow">break</span>;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca875ace9b639af0d1640e8c597ddf7c0d">adcRefVDD</a>:
<a name="l00121"></a>00121     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SCANOFFSET_MASK | _ADC_CAL_SCANGAIN_MASK);
<a name="l00122"></a>00122     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_VDD_GAIN_MASK) &gt;&gt;
<a name="l00123"></a>00123             _DEVINFO_ADC0CAL1_VDD_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SCANGAIN_SHIFT;
<a name="l00124"></a>00124     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_VDD_OFFSET_MASK) &gt;&gt;
<a name="l00125"></a>00125             _DEVINFO_ADC0CAL1_VDD_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SCANOFFSET_SHIFT;
<a name="l00126"></a>00126     adc-&gt;CAL = cal;
<a name="l00127"></a>00127     <span class="keywordflow">break</span>;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eacab8fa2a2f4bc48d4f5e46173714288fca">adcRef5VDIFF</a>:
<a name="l00130"></a>00130     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SCANOFFSET_MASK | _ADC_CAL_SCANGAIN_MASK);
<a name="l00131"></a>00131     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_5VDIFF_GAIN_MASK) &gt;&gt;
<a name="l00132"></a>00132             _DEVINFO_ADC0CAL1_5VDIFF_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SCANGAIN_SHIFT;
<a name="l00133"></a>00133     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_5VDIFF_OFFSET_MASK) &gt;&gt;
<a name="l00134"></a>00134             _DEVINFO_ADC0CAL1_5VDIFF_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SCANOFFSET_SHIFT;
<a name="l00135"></a>00135     adc-&gt;CAL = cal;
<a name="l00136"></a>00136     <span class="keywordflow">break</span>;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca85d6fcd5c42fbc583bb02eb5374cd702">adcRef2xVDD</a>:
<a name="l00139"></a>00139     <span class="comment">/* Gain value not of relevance for this reference, leave as is */</span>
<a name="l00140"></a>00140     cal  = adc-&gt;CAL &amp; ~_ADC_CAL_SCANOFFSET_MASK;
<a name="l00141"></a>00141     cal |= ((DEVINFO-&gt;ADC0CAL2 &amp; _DEVINFO_ADC0CAL2_2XVDDVSS_OFFSET_MASK) &gt;&gt;
<a name="l00142"></a>00142             _DEVINFO_ADC0CAL2_2XVDDVSS_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SCANOFFSET_SHIFT;
<a name="l00143"></a>00143     adc-&gt;CAL = cal;
<a name="l00144"></a>00144     <span class="keywordflow">break</span>;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="comment">/* For external references, the calibration must be determined for the */</span>
<a name="l00147"></a>00147   <span class="comment">/* specific application and set explicitly. */</span>
<a name="l00148"></a>00148   <span class="keywordflow">default</span>:
<a name="l00149"></a>00149     <span class="keywordflow">break</span>;
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">/***************************************************************************/</span>
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">void</span> ADC_CalibrateLoadSingle(ADC_TypeDef *adc, <a class="code" href="group__ADC.html#ga90e3c5bfd7ebdd7686cf65bb896e4eac">ADC_Ref_TypeDef</a> ref)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173   uint32_t cal;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="comment">/* Load proper calibration data depending on selected reference */</span>
<a name="l00176"></a>00176   <span class="comment">/* NOTE: We use ...SCAN... defines below, they are the same as */</span>
<a name="l00177"></a>00177   <span class="comment">/* similar ...SINGLE... defines. */</span>
<a name="l00178"></a>00178   <span class="keywordflow">switch</span> (ref)
<a name="l00179"></a>00179   {
<a name="l00180"></a>00180   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca97f40de792c64102ddbf60b0faa82c32">adcRef1V25</a>:
<a name="l00181"></a>00181     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SINGLEOFFSET_MASK | _ADC_CAL_SINGLEGAIN_MASK);
<a name="l00182"></a>00182     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_1V25_GAIN_MASK) &gt;&gt;
<a name="l00183"></a>00183             _DEVINFO_ADC0CAL0_1V25_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SINGLEGAIN_SHIFT;
<a name="l00184"></a>00184     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_1V25_OFFSET_MASK) &gt;&gt;
<a name="l00185"></a>00185             _DEVINFO_ADC0CAL0_1V25_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SINGLEOFFSET_SHIFT;
<a name="l00186"></a>00186     adc-&gt;CAL = cal;
<a name="l00187"></a>00187     <span class="keywordflow">break</span>;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca611947cfb4d734ac07e6d44967ca28ce">adcRef2V5</a>:
<a name="l00190"></a>00190     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SINGLEOFFSET_MASK | _ADC_CAL_SINGLEGAIN_MASK);
<a name="l00191"></a>00191     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_2V5_GAIN_MASK) &gt;&gt;
<a name="l00192"></a>00192             _DEVINFO_ADC0CAL0_2V5_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SINGLEGAIN_SHIFT;
<a name="l00193"></a>00193     cal |= ((DEVINFO-&gt;ADC0CAL0 &amp; _DEVINFO_ADC0CAL0_2V5_OFFSET_MASK) &gt;&gt;
<a name="l00194"></a>00194             _DEVINFO_ADC0CAL0_2V5_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SINGLEOFFSET_SHIFT;
<a name="l00195"></a>00195     adc-&gt;CAL = cal;
<a name="l00196"></a>00196     <span class="keywordflow">break</span>;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca875ace9b639af0d1640e8c597ddf7c0d">adcRefVDD</a>:
<a name="l00199"></a>00199     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SINGLEOFFSET_MASK | _ADC_CAL_SINGLEGAIN_MASK);
<a name="l00200"></a>00200     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_VDD_GAIN_MASK) &gt;&gt;
<a name="l00201"></a>00201             _DEVINFO_ADC0CAL1_VDD_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SINGLEGAIN_SHIFT;
<a name="l00202"></a>00202     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_VDD_OFFSET_MASK) &gt;&gt;
<a name="l00203"></a>00203             _DEVINFO_ADC0CAL1_VDD_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SINGLEOFFSET_SHIFT;
<a name="l00204"></a>00204     adc-&gt;CAL = cal;
<a name="l00205"></a>00205     <span class="keywordflow">break</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eacab8fa2a2f4bc48d4f5e46173714288fca">adcRef5VDIFF</a>:
<a name="l00208"></a>00208     cal  = adc-&gt;CAL &amp; ~(_ADC_CAL_SINGLEOFFSET_MASK | _ADC_CAL_SINGLEGAIN_MASK);
<a name="l00209"></a>00209     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_5VDIFF_GAIN_MASK) &gt;&gt;
<a name="l00210"></a>00210             _DEVINFO_ADC0CAL1_5VDIFF_GAIN_SHIFT) &lt;&lt; _ADC_CAL_SINGLEGAIN_SHIFT;
<a name="l00211"></a>00211     cal |= ((DEVINFO-&gt;ADC0CAL1 &amp; _DEVINFO_ADC0CAL1_5VDIFF_OFFSET_MASK) &gt;&gt;
<a name="l00212"></a>00212             _DEVINFO_ADC0CAL1_5VDIFF_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SINGLEOFFSET_SHIFT;
<a name="l00213"></a>00213     adc-&gt;CAL = cal;
<a name="l00214"></a>00214     <span class="keywordflow">break</span>;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="keywordflow">case</span> <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca85d6fcd5c42fbc583bb02eb5374cd702">adcRef2xVDD</a>:
<a name="l00217"></a>00217     <span class="comment">/* Gain value not of relevance for this reference, leave as is */</span>
<a name="l00218"></a>00218     cal  = adc-&gt;CAL &amp; ~_ADC_CAL_SINGLEOFFSET_MASK;
<a name="l00219"></a>00219     cal |= ((DEVINFO-&gt;ADC0CAL2 &amp; _DEVINFO_ADC0CAL2_2XVDDVSS_OFFSET_MASK) &gt;&gt;
<a name="l00220"></a>00220             _DEVINFO_ADC0CAL2_2XVDDVSS_OFFSET_SHIFT) &lt;&lt; _ADC_CAL_SINGLEOFFSET_SHIFT;
<a name="l00221"></a>00221     adc-&gt;CAL = cal;
<a name="l00222"></a>00222     <span class="keywordflow">break</span>;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="comment">/* For external references, the calibration must be determined for the */</span>
<a name="l00225"></a>00225   <span class="comment">/* specific application and set explicitly. */</span>
<a name="l00226"></a>00226   <span class="keywordflow">default</span>:
<a name="l00227"></a>00227     <span class="keywordflow">break</span>;
<a name="l00228"></a>00228   }
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00233"></a>00233 <span class="comment">/*******************************************************************************</span>
<a name="l00234"></a>00234 <span class="comment"> **************************   GLOBAL FUNCTIONS   *******************************</span>
<a name="l00235"></a>00235 <span class="comment"> ******************************************************************************/</span>
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">/***************************************************************************/</span>
<a name="l00255"></a><a class="code" href="group__ADC.html#ga3d5a968fbc40b29ebc05f17b311f2eb9">00255</a> <span class="keywordtype">void</span> <a class="code" href="group__ADC.html#ga3d5a968fbc40b29ebc05f17b311f2eb9" title="Initialize ADC.">ADC_Init</a>(ADC_TypeDef *adc, <span class="keyword">const</span> <a class="code" href="structADC__Init__TypeDef.html">ADC_Init_TypeDef</a> *init)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257   uint32_t tmp;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   EFM_ASSERT(ADC_REF_VALID(adc));
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   <span class="comment">/* Make sure conversion is not in progress */</span>
<a name="l00262"></a>00262   adc-&gt;CMD = ADC_CMD_SINGLESTOP | ADC_CMD_SCANSTOP;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   tmp = ((uint32_t)(init-&gt;<a class="code" href="structADC__Init__TypeDef.html#abd87f85b8c594baee7981ec252998618">ovsRateSel</a>) &lt;&lt; _ADC_CTRL_OVSRSEL_SHIFT) |
<a name="l00265"></a>00265         (((uint32_t)(init-&gt;<a class="code" href="structADC__Init__TypeDef.html#a8a4fdc6c3ba9c0b3bad5270e2614134e">timebase</a>) &lt;&lt; _ADC_CTRL_TIMEBASE_SHIFT) &amp; _ADC_CTRL_TIMEBASE_MASK) |
<a name="l00266"></a>00266         (((uint32_t)(init-&gt;<a class="code" href="structADC__Init__TypeDef.html#afea4e566991ef1c7d0e12035f5efe8a3">prescale</a>) &lt;&lt; _ADC_CTRL_PRESC_SHIFT) &amp; _ADC_CTRL_PRESC_MASK) |
<a name="l00267"></a>00267         ((uint32_t)(init-&gt;<a class="code" href="structADC__Init__TypeDef.html#aeb7d380d6aefa3e2b8fa9150cb2af1e7">lpfMode</a>) &lt;&lt; _ADC_CTRL_LPFMODE_SHIFT) |
<a name="l00268"></a>00268         ((uint32_t)(init-&gt;<a class="code" href="structADC__Init__TypeDef.html#ac20d26a2e7384f0f648600e446261629">warmUpMode</a>) &lt;&lt; _ADC_CTRL_WARMUPMODE_SHIFT);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__Init__TypeDef.html#abb40c65ecf8b039794fb7196e720f3cf">tailgate</a>)
<a name="l00271"></a>00271   {
<a name="l00272"></a>00272     tmp |= ADC_CTRL_TAILGATE;
<a name="l00273"></a>00273   }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275   adc-&gt;CTRL = tmp;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="comment">/***************************************************************************/</span>
<a name="l00299"></a><a class="code" href="group__ADC.html#ga41207273ca90e4173084233060e0edbb">00299</a> <span class="keywordtype">void</span> <a class="code" href="group__ADC.html#ga41207273ca90e4173084233060e0edbb" title="Initialize ADC scan sequence.">ADC_InitScan</a>(ADC_TypeDef *adc, <span class="keyword">const</span> <a class="code" href="structADC__InitScan__TypeDef.html">ADC_InitScan_TypeDef</a> *init)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301   uint32_t tmp;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   EFM_ASSERT(ADC_REF_VALID(adc));
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">/* Make sure scan sequence is not in progress */</span>
<a name="l00306"></a>00306   adc-&gt;CMD = ADC_CMD_SCANSTOP;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   <span class="comment">/* Load proper calibration data depending on selected reference */</span>
<a name="l00309"></a>00309   ADC_CalibrateLoadScan(adc, init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#aeee42559908020ede887a53775cfe1ef">reference</a>);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311   tmp = ((uint32_t)(init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#aaf96f12fb19c8fa3ec8b8f7edbf33f37">prsSel</a>) &lt;&lt; _ADC_SCANCTRL_PRSSEL_SHIFT) |
<a name="l00312"></a>00312         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#afe0305e5c4ff30be937adf199052ffc5">acqTime</a>) &lt;&lt; _ADC_SCANCTRL_AT_SHIFT) |
<a name="l00313"></a>00313         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#aeee42559908020ede887a53775cfe1ef">reference</a>) &lt;&lt; _ADC_SCANCTRL_REF_SHIFT) |
<a name="l00314"></a>00314         init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#aba83a966d8cfbfb81c1a5adfde978794">input</a> |
<a name="l00315"></a>00315         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#a8d7d55f3b72942e71ff3eb87a1792303">resolution</a>) &lt;&lt; _ADC_SCANCTRL_RES_SHIFT);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#a552538ad388b6d36e2f5074f2a7caa67">prsEnable</a>)
<a name="l00318"></a>00318   {
<a name="l00319"></a>00319     tmp |= ADC_SCANCTRL_PRSEN;
<a name="l00320"></a>00320   }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#afaeb7c7c6aa576a679de08b1c1b23845">leftAdjust</a>)
<a name="l00323"></a>00323   {
<a name="l00324"></a>00324     tmp |= ADC_SCANCTRL_ADJ_LEFT;
<a name="l00325"></a>00325   }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#a5a3ec4ec81c389a5a72b6c7b0cf797d7">diff</a>)
<a name="l00328"></a>00328   {
<a name="l00329"></a>00329     tmp |= ADC_SCANCTRL_DIFF;
<a name="l00330"></a>00330   }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitScan__TypeDef.html#aa42a6f2f8094c12b7da7a28673cf39ba">rep</a>)
<a name="l00333"></a>00333   {
<a name="l00334"></a>00334     tmp |= ADC_SCANCTRL_REP;
<a name="l00335"></a>00335   }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   adc-&gt;SCANCTRL = tmp;
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">/***************************************************************************/</span>
<a name="l00361"></a><a class="code" href="group__ADC.html#ga76aa8949d51eb1027906f68b0952ea0e">00361</a> <span class="keywordtype">void</span> <a class="code" href="group__ADC.html#ga76aa8949d51eb1027906f68b0952ea0e" title="Initialize single ADC sample conversion.">ADC_InitSingle</a>(ADC_TypeDef *adc, <span class="keyword">const</span> <a class="code" href="structADC__InitSingle__TypeDef.html">ADC_InitSingle_TypeDef</a> *init)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363   uint32_t tmp;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   EFM_ASSERT(ADC_REF_VALID(adc));
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   <span class="comment">/* Make sure single conversion is not in progress */</span>
<a name="l00368"></a>00368   adc-&gt;CMD = ADC_CMD_SINGLESTOP;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <span class="comment">/* Load proper calibration data depending on selected reference */</span>
<a name="l00371"></a>00371   ADC_CalibrateLoadSingle(adc, init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a4751bd8ba80b6b1f8c67a793928ea85c">reference</a>);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   tmp = ((uint32_t)(init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#abe3677451c9916ae5f84318f090b5dbf">prsSel</a>) &lt;&lt; _ADC_SINGLECTRL_PRSSEL_SHIFT) |
<a name="l00374"></a>00374         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#ab5774ab856a328f3f01e238cf92f96a9">acqTime</a>) &lt;&lt; _ADC_SINGLECTRL_AT_SHIFT) |
<a name="l00375"></a>00375         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a4751bd8ba80b6b1f8c67a793928ea85c">reference</a>) &lt;&lt; _ADC_SINGLECTRL_REF_SHIFT) |
<a name="l00376"></a>00376         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#aff9c4c85f07033aa543652c6c2ee366e">input</a>) &lt;&lt; _ADC_SINGLECTRL_INPUTSEL_SHIFT) |
<a name="l00377"></a>00377         ((uint32_t)(init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a9ee5b016f52095cd030e2e7b1780186c">resolution</a>) &lt;&lt; _ADC_SINGLECTRL_RES_SHIFT);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a153191dfba6578e9975c41a753ce65eb">prsEnable</a>)
<a name="l00380"></a>00380   {
<a name="l00381"></a>00381     tmp |= ADC_SINGLECTRL_PRSEN;
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a64d99bb9d75e905b8a464233cb764c0e">leftAdjust</a>)
<a name="l00385"></a>00385   {
<a name="l00386"></a>00386     tmp |= ADC_SINGLECTRL_ADJ_LEFT;
<a name="l00387"></a>00387   }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#a8ca356b274b37427cf2ab20bdd085a08">diff</a>)
<a name="l00390"></a>00390   {
<a name="l00391"></a>00391     tmp |= ADC_SINGLECTRL_DIFF;
<a name="l00392"></a>00392   }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394   <span class="keywordflow">if</span> (init-&gt;<a class="code" href="structADC__InitSingle__TypeDef.html#aef3e7be9b4ddc55404d36658d6d388b8">rep</a>)
<a name="l00395"></a>00395   {
<a name="l00396"></a>00396     tmp |= ADC_SINGLECTRL_REP;
<a name="l00397"></a>00397   }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   adc-&gt;SINGLECTRL = tmp;
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="comment">/***************************************************************************/</span>
<a name="l00420"></a><a class="code" href="group__ADC.html#ga635eb5e70c406ff3bd150b8e695a70f9">00420</a> uint8_t <a class="code" href="group__ADC.html#ga635eb5e70c406ff3bd150b8e695a70f9" title="Calculate prescaler value used to determine ADC clock.">ADC_PrescaleCalc</a>(uint32_t adcFreq, uint32_t hfperFreq)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422   uint32_t ret;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="comment">/* Make sure selected ADC clock is within valid range */</span>
<a name="l00425"></a>00425   <span class="keywordflow">if</span> (adcFreq &gt; ADC_MAX_CLOCK)
<a name="l00426"></a>00426   {
<a name="l00427"></a>00427     adcFreq = ADC_MAX_CLOCK;
<a name="l00428"></a>00428   }
<a name="l00429"></a>00429   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adcFreq &lt; ADC_MIN_CLOCK)
<a name="l00430"></a>00430   {
<a name="l00431"></a>00431     adcFreq = ADC_MIN_CLOCK;
<a name="l00432"></a>00432   }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   <span class="comment">/* Use current HFPER frequency? */</span>
<a name="l00435"></a>00435   <span class="keywordflow">if</span> (!hfperFreq)
<a name="l00436"></a>00436   {
<a name="l00437"></a>00437     hfperFreq = <a class="code" href="group__CMU.html#gac9aa0ed17f83bd48abcf7b430843374a" title="Get clock frequency for a clock point.">CMU_ClockFreqGet</a>(<a class="code" href="group__CMU.html#gga519ea66a1a21e07f2d1cccc9aa55799eafdbf6d011629cb273654aa780dc3d00f">cmuClock_HFPER</a>);
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   ret = (hfperFreq + adcFreq - 1) / adcFreq;
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (ret)
<a name="l00442"></a>00442   {
<a name="l00443"></a>00443     ret--;
<a name="l00444"></a>00444   }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="keywordflow">return</span> (uint8_t)ret;
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="comment">/***************************************************************************/</span>
<a name="l00461"></a><a class="code" href="group__ADC.html#ga75639a8eba9a3353c216b324e554827e">00461</a> <span class="keywordtype">void</span> <a class="code" href="group__ADC.html#ga75639a8eba9a3353c216b324e554827e" title="Reset ADC to same state as after a HW reset.">ADC_Reset</a>(ADC_TypeDef *adc)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463   <span class="comment">/* Stop conversions, before resetting other registers. */</span>
<a name="l00464"></a>00464   adc-&gt;CMD        = ADC_CMD_SINGLESTOP | ADC_CMD_SCANSTOP;
<a name="l00465"></a>00465   adc-&gt;SINGLECTRL = _ADC_SINGLECTRL_RESETVALUE;
<a name="l00466"></a>00466   adc-&gt;SCANCTRL   = _ADC_SCANCTRL_RESETVALUE;
<a name="l00467"></a>00467   adc-&gt;CTRL       = _ADC_CTRL_RESETVALUE;
<a name="l00468"></a>00468   adc-&gt;IEN        = _ADC_IEN_RESETVALUE;
<a name="l00469"></a>00469   adc-&gt;IFC        = _ADC_IFC_MASK;
<a name="l00470"></a>00470   adc-&gt;BIASPROG   = _ADC_BIASPROG_RESETVALUE;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   <span class="comment">/* Load calibration values for the 1V25 internal reference. */</span>
<a name="l00473"></a>00473   ADC_CalibrateLoadSingle(adc, <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca97f40de792c64102ddbf60b0faa82c32">adcRef1V25</a>);
<a name="l00474"></a>00474   ADC_CalibrateLoadScan(adc, <a class="code" href="group__ADC.html#gga90e3c5bfd7ebdd7686cf65bb896e4eaca97f40de792c64102ddbf60b0faa82c32">adcRef1V25</a>);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <span class="comment">/* Do not reset route register, setting should be done independently */</span>
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">/***************************************************************************/</span>
<a name="l00490"></a><a class="code" href="group__ADC.html#ga95a5a908501b6c3bbd44022d41205e73">00490</a> uint8_t <a class="code" href="group__ADC.html#ga95a5a908501b6c3bbd44022d41205e73" title="Calculate timebase value in order to get a timebase providing at least 1us.">ADC_TimebaseCalc</a>(uint32_t hfperFreq)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492   <span class="keywordflow">if</span> (!hfperFreq)
<a name="l00493"></a>00493   {
<a name="l00494"></a>00494     hfperFreq = <a class="code" href="group__CMU.html#gac9aa0ed17f83bd48abcf7b430843374a" title="Get clock frequency for a clock point.">CMU_ClockFreqGet</a>(<a class="code" href="group__CMU.html#gga519ea66a1a21e07f2d1cccc9aa55799eafdbf6d011629cb273654aa780dc3d00f">cmuClock_HFPER</a>);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="comment">/* Just in case, make sure we get non-zero freq for below calculation */</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (!hfperFreq)
<a name="l00498"></a>00498     {
<a name="l00499"></a>00499       hfperFreq = 1;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501   }
<a name="l00502"></a>00502 <span class="preprocessor">#if defined(_EFM32_GIANT_FAMILY) || defined(_EFM32_WONDER_FAMILY)</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span>  <span class="comment">/* Handle errata on Giant Gecko, max TIMEBASE is 5 bits wide or max 0x1F */</span>
<a name="l00504"></a>00504   <span class="comment">/* cycles. This will give a warmp up time of e.g. 0.645us, not the       */</span>
<a name="l00505"></a>00505   <span class="comment">/* required 1us when operating at 48MHz. One must also increase acqTime  */</span>
<a name="l00506"></a>00506   <span class="comment">/* to compensate for the missing clock cycles, adding up to 1us in total.*/</span>
<a name="l00507"></a>00507   <span class="comment">/* See reference manual for details. */</span>
<a name="l00508"></a>00508   <span class="keywordflow">if</span>( hfperFreq &gt; 32000000 )
<a name="l00509"></a>00509   {
<a name="l00510"></a>00510     hfperFreq = 32000000;
<a name="l00511"></a>00511   }
<a name="l00512"></a>00512 <span class="preprocessor">#endif</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>  <span class="comment">/* Determine number of HFPERCLK cycle &gt;= 1us */</span>
<a name="l00514"></a>00514   hfperFreq += 999999;
<a name="l00515"></a>00515   hfperFreq /= 1000000;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <span class="comment">/* Return timebase value (N+1 format) */</span>
<a name="l00518"></a>00518   <span class="keywordflow">return</span> (uint8_t)(hfperFreq - 1);
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 
<a name="l00524"></a>00524 <span class="preprocessor">#endif </span><span class="comment">/* defined(ADC_COUNT) &amp;&amp; (ADC_COUNT &gt; 0) */</span>
</pre></div></div>
<div id="footer">
<hr size="1"><address style="text-align: right;"><small>
Generated on Thu May 28 06:03:04 2015</small> for Silicon Labs EFM32 emlib Peripheral Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a><small> 1.6.3 </small></address></div>
</body>
</html>
